<!DOCTYPE html>
<html>
  <head>
    <link rel="stylesheet" href="stylesheets/style.css?after" />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
      integrity="sha512-9usAa10IRO0HhonpyAIVpjrylPvoDwiPUiKdWk5t3PyolY1cOd4DSE0Ga+ri4AuTroPR5aQvXU9xC6qOPnzFeg=="
      crossorigin="anonymous"
      referrerpolicy="no-referrer"
    />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Jua&display=swap"
      rel="stylesheet"
    />
  </head>
  <body>
    <div class="boxes">
      <div class="box1">
        <p id="title">Safe Road test</p>
      </div>
      <div class="box2">
        <div class="box"></div>
        <div class="box"></div>
      </div>
      <div class="box3">
        <div class="box"></div>
        <div class="box"></div>
      </div>
      <div class="box4">
        <div id="hrtbox" class="box">
          <p>현재 심박수</p>
          <p id="hrt">0</p>
        </div>
        <div class="box"></div>
      </div>
      <div class="box5">
        <button type="button" onclick="init()">Start</button>
        <div id="label-container"></div>
        <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@1.3.1/dist/tf.min.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/speech-commands@0.4.0/dist/speech-commands.min.js"></script>
        <p id="currentDisplay"></p>
        <p id="swearCountDisplay"></p>
        <p id="swearAlertDisplay"></p>

        <script type="text/javascript">
          // more documentation available at
          // https://github.com/tensorflow/tfjs-models/tree/master/speech-commands

          // the link to your model provided by Teachable Machine export panel
          const URL =
            "https://teachablemachine.withgoogle.com/models/s5qwN9lB_/";

          let status = "Background Noise";
          let currentDetection = document.getElementById("currentDisplay");
          let swearCountDisplay = document.getElementById("swearCountDisplay");
          let swearAlertDisplay = document.getElementById("swearAlertDisplay");

          //-------------------------------DONT EDIT BELOW---------------------
          async function createModel() {
            const checkpointURL = URL + "model.json"; // model topology
            const metadataURL = URL + "metadata.json"; // model metadata

            const recognizer = speechCommands.create(
              "BROWSER_FFT", // fourier transform type, not useful to change
              undefined, // speech commands vocabulary feature, not useful for your models
              checkpointURL,
              metadataURL
            );

            // check that model and metadata are loaded via HTTPS requests.
            await recognizer.ensureModelLoaded();

            return recognizer;
          }
          //-----------------------------------------------------------------------
          async function init() {
            const recognizer = await createModel();
            const classLabels = recognizer.wordLabels(); // get class labels
            const labelContainer = document.getElementById("label-container");

            var swearCount = 0;
            var nonSwearCount = 0;
            var swearCountArray = new Array(0, 0);
            var angryLevel = 0;

            for (let i = 0; i < classLabels.length; i++) {
              labelContainer.appendChild(document.createElement("div"));
            }

            // listen() takes two arguments:
            // 1. A callback function that is invoked anytime a word is recognized.
            // 2. A configuration object with adjustable fields
            recognizer.listen(
              (result) => {
                const scores = result.scores; // probability of prediction for each class
                // render the probability scores per class
                for (let i = 0; i < classLabels.length; i++) {
                  const classPrediction =
                    classLabels[i] + ": " + result.scores[i].toFixed(2);
                  labelContainer.childNodes[i].innerHTML = classPrediction;
                }

                for (let i = 0; i < 9; i++) {
                  if (result.scores[i] >= 0.8) {
                    status = classLabels[i]; //(0:test 1:개새끼 2:미친 3,4,5: 배경소음 6:씨발 7:씨발(장난) 8:욕설
                    if (i == 1 || i == 2 || i == 6 || i == 8) {
                      swearCountArray[0]++;
                    } else swearCountArray[1]++;
                  }
                  setTimeout(function () {
                    swearcount = 0;
                    swearCountArray[0] = 0;
                    swearCountArray[1] = 0;
                  }, 10000);
                }

                currentDetection.innerHTML = "현재 인식 단어: " + status;
                swearCountDisplay.innerHTML =
                  "욕설" +
                  swearCountArray[0] +
                  "회" +
                  "  욕설 아님" +
                  swearCountArray[1] +
                  "회";
                if (swearCountArray[0] > 2) {
                  swearAlertDisplay.innerHTML =
                    " 욕설이 2회 이상 감지되었습니다. ";
                } else {
                  swearAlertDisplay.innerHTML = " 난폭운전 예방 시스템 ";
                }
              },
              {
                includeSpectrogram: true, // in case listen should return result.spectrogram
                probabilityThreshold: 0.75,
                invokeCallbackOnNoiseAndUnknown: true,
                overlapFactor: 0.5, // probably want between 0.5 and 0.75. More info in README
              }
            );

            // Stop the recognition in 5 seconds.
            // setTimeout(() => recognizer.stopListening(), 5000);
          }
        </script>
      </div>
    </div>
  </body>
  <script src="./index.html"></script>
</html>
